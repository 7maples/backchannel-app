%h3 #{@track_show.track['title']}'s backchannel
%section
  .row
    .span5
      %h3 Chat
      %ul.chat{"data-id" => "#{@track_show.track_id}"}
        = render partial: 'message', collection: @track_show.messages

      %input.span4#body{:type => "text", :placeholder => "Type your message here"}
      %button.btn#post Send


    .span6
      %h3 Questions
      %ul.questions
        %li
          .question-container
            .question
              %h3 Which refactoring technique do think is the most versatile?
              %span.badge.badge-inverse 12 votes
            .asker-info
              .img-container
                %img.img-circle{"data-src"=>"assets/holder.png", :src => "assets/holder.png"}

              %p kareemgrant
              %button.btn.pull-right vote
        %li
          .question-container
            .question
              %h3 Which refactoring technique do think is the most versatile?
              %span.badge.badge-inverse 12 votes
            .asker-info
              .img-container
                %img.img-circle{"data-src"=>"assets/holder.png", :src => "assets/holder.png"}

              %p kareemgrant
              %button.btn.pull-right vote
      %button.btn.btn-primary.pull-right Ask a question
              
:javascript
  $(function(){
    var client = new Faye.Client('http://localhost:9292/faye');

    client.subscribe("/tracks/#{@track_show.track_id}", function (data) {

      var userIds = gon.track_show.user_ids,
          users = gon.track_show.users, 
          chatUserId = data.text.user_id;

      if ($.inArray(chatUserId, userIds) !== -1) {
        $('.chat').append('<li>' + "<img class='img-circle', src='"+ users[data.text.user_id].image_url + "'/>" + ' ' + users[data.text.user_id].nickname + ' says: ' + data.text.body + '</li>')
      } else {
        $.ajax({
          type: 'GET',
          url: '/users/' + data.text.user_id,
          success: function (response) {
            console.log("making a get request");
            $('.chat').append('<li>' + "<img class='img-circle', src='"+ response.image_url + "'/>" + ' ' + response.nickname + ' says: ' + data.text.body + '</li>')
          }
        })
      };
    });

    $("#post").click(function() {
      var $body = $("#body"),
          message = $body.val();

      $body.val('');

      $.ajax({
        type: "POST",
        url:  "/#{@track_show.conference_slug}/#{@track_show.track_id}/messages",
        data: {body: message},
        dataType: "json",
        success: function (response) {
        },
        error: function (error) {
        }
      });

    });
  });
